<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>With Pet</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=o5gi6azzqk&submodules=geocoder"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/map.css" />

</head>
<body>
<div id="wrap" class="section">
    <h1>
        <a href="main.html">
            <img src="image/logo1.png" alt="With Pet">
        </a>
    </h1>

    <div class="search">
        <input id="address" type="text" placeholder="ê²€ìƒ‰í•  ì£¼ì†Œ" />
        <input id="submit" type="button" value="ì£¼ì†Œ ê²€ìƒ‰" />
        <input id="park-submit" type="button" value="ê³µì› ê²€ìƒ‰" />
    </div>
    <div id="map"></div>
    <div class="button-container">
        <div class="submit-form" data-query="ì–‘ì‹">
            <figure>
                <img src="image/004-hamburger.png" alt="ì–‘ì‹">
                <figcaption>ì–‘ì‹</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="í•œì‹">
            <figure>
                <img src="image/006-bibimbap.png" alt="í•œì‹">
                <figcaption>í•œì‹</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ì¼ì‹">
            <figure>
                <img src="image/005-sushi.png" alt="ì¼ì‹">
                <figcaption>ì¼ì‹</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ì¤‘í™”ìš”ë¦¬">
            <figure>
                <img src="image/007-buns-1.png" alt="ì¤‘í™”ìš”ë¦¬">
                <figcaption>ì¤‘ì‹</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ì¹´í˜">
            <figure>
                <img src="image/002-coffee-1.png" alt="ì¹´í˜">
                <figcaption>ì¹´í˜</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ë¶„ì‹">
            <figure>
                <img src="image/004-tteokbokki.png" alt="ë¶„ì‹">
                <figcaption>ë¶„ì‹</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="í•´ì‚°ë¬¼">
            <figure>
                <img src="image/005-lobster.png" alt="í•´ì‚°ë¬¼">
                <figcaption>í•´ì‚°ë¬¼</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ë² íŠ¸ë‚¨">
            <figure>
                <img src="image/002-noodle.png" alt="ë² íŠ¸ë‚¨">
                <figcaption>ë² íŠ¸ë‚¨</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="íƒœêµ­">
            <figure>
                <img src="image/001-thai-food.png" alt="íƒœêµ­">
                <figcaption>íƒœêµ­</figcaption>
            </figure>
        </div>
        <div class="submit-form" data-query="ë©•ì‹œì½”">
            <figure>
                <img src="image/003-taco.png" alt="ë©•ì‹œì½”">
                <figcaption>ë©•ì‹œì½”</figcaption>
            </figure>
        </div>
    </div>
</div>

<script>
    // ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function setMapToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const userLocation = new naver.maps.LatLng(
                        position.coords.latitude,
                        position.coords.longitude
                    );

                    map.setCenter(userLocation);
                    map.setZoom(15);

                    const marker = new naver.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: 'í˜„ì¬ ìœ„ì¹˜'
                    });

                    const infoWindow = new naver.maps.InfoWindow({
                        content: '<div style="padding:10px;">í˜„ì¬ ìœ„ì¹˜</div>'
                    });

                    infoWindow.open(map, marker);
                },
                function (error) {
                    console.error("Geolocation ì˜¤ë¥˜:", error);
                    alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            );
        } else {
            alert("Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        }
    }

    var map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.5666805, 126.9784147), // ê¸°ë³¸ ìœ„ì¹˜ (ì„œìš¸)
        zoom: 15,
        mapTypeControl: true
    });

    setMapToCurrentLocation(); // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì„¤ì •

    map.setCursor('pointer');

    // í‰ê·  í‰ì ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
function calculateAverageRating(place) {
    const reviews = JSON.parse(localStorage.getItem('reviews')) || [];
    const placeReviews = reviews.filter(review => review.place === place);

    if (placeReviews.length === 0) return 'í‰ì  ì—†ìŒ';

    const totalRating = placeReviews.reduce((sum, review) => sum + parseInt(review.rating, 10), 0);
    const averageRating = (totalRating / placeReviews.length).toFixed(1);
    return `í‰ì : ${averageRating}`;
}

// ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ê°„ë‹¨í•œ ì •ë³´ í‘œì‹œ
function addMarkerWithEvents(item, wgs84) {
    const marker = new naver.maps.Marker({
        position: wgs84,
        map: map,
        title: item.title
    });

    // ë§ˆì»¤ í´ë¦­ ì‹œ ë‚˜ì˜¤ëŠ” ìƒì„¸ ì •ë³´ì°½ì— í‰ì  ì¶”ê°€
    const averageRatingText = calculateAverageRating(item.title);
    const detailedInfoWindow = new naver.maps.InfoWindow({
        content: `
            <div style="padding:10px;">
                <strong>${item.title}</strong><br/>
                <span>${item.category}</span><br/>
                <span>${item.address}</span><br/>
                <span>${averageRatingText}</span><br/>
                <a href="${item.link}" target="_blank">ìƒì„¸ì •ë³´</a><br/>
                <a href="review.html?place=${encodeURIComponent(item.title)}">ë¦¬ë·°</a>
            </div>`
    });

    naver.maps.Event.addListener(marker, 'click', function () {
        detailedInfoWindow.open(map, marker);
    });

    return marker;
}

// ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function displayResults(data) {
    const results = data.items;
    let output = '';

    results.forEach((item, index) => {
        const mapx = parseFloat(item.mapx.substring(0, 3) + '.' + item.mapx.substring(3));
        const mapy = parseFloat(item.mapy.substring(0, 2) + '.' + item.mapy.substring(2));
        const wgs84 = new naver.maps.LatLng(mapy, mapx);

        const marker = addMarkerWithEvents(item, wgs84); // ë§ˆì»¤ ì¶”ê°€

        // í…Œì´ë¸”ì— ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        output += `<tr><td><a href="${item.link}" target="_blank">${index + 1}. ${item.title}</a></td></tr>`;
    });

    $('#local-results').html(output);
}

 async function searchParksNearby() {
    const address = $('#address').val();
    const query = `${address} ê³µì›`; // Add park category
    const encodedAddress = encodeURIComponent(query);
    const apiUrl = `https://openapi.naver.com/v1/search/local?query=${encodedAddress}&display=100`;

    const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // Use proxy server
    const requestUrl = proxyUrl + apiUrl;

    const clientId = 'XHZ9ADZ2rrQWqLCtLrc6'; // Naver Client ID
    const clientSecret = 'BEuGuzPjRB'; // Naver Client Secret

    try {
        const response = await fetch(requestUrl, {
            method: 'GET',
            headers: {
                'X-Naver-Client-Id': clientId,
                'X-Naver-Client-Secret': clientSecret
            }
        });

        if (!response.ok) {
            throw new Error('API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();

        // Filter parks from the response
        const parks = data.items.filter(item => item.category.includes('ê³µì›'));

        if (parks.length > 0) {
            // Center the map on the first park's location
            const firstPark = parks[0];
            const mapx = parseFloat(firstPark.mapx.substring(0, 3) + '.' + firstPark.mapx.substring(3));
            const mapy = parseFloat(firstPark.mapy.substring(0, 2) + '.' + firstPark.mapy.substring(2));
            const newLocation = new naver.maps.LatLng(mapy, mapx);

            // Set the map center and zoom level
            map.setCenter(newLocation);
            map.setZoom(15); // Adjust zoom level as needed

            // Create markers for all parks
            parks.forEach((item, index) => {
                const mapx = parseFloat(item.mapx.substring(0, 3) + '.' + item.mapx.substring(3));
                const mapy = parseFloat(item.mapy.substring(0, 2) + '.' + item.mapy.substring(2));
                const newLocation = new naver.maps.LatLng(mapy, mapx);

                // Create a custom park marker
                const parkMarker = new naver.maps.Marker({
                    position: newLocation,
                    map: map,
                    title: item.title,
                    icon: {
                        content: '<div class="park-marker">ğŸŒ³</div>',
                        size: new naver.maps.Size(30, 30),
                        anchor: new naver.maps.Point(15, 30),
                    }
                });

                // Create an info window for the park
                const infoWindow = new naver.maps.InfoWindow({
                    content: `<div style="padding:10px;">
                                  <strong>${item.title}</strong><br />
                                  <span>${item.category}</span><br />
                                  <span>${item.roadAddress || item.address}</span><br />
                                  <a href="review.html?place=${encodeURIComponent(item.title)}">ë¦¬ë·°</a>
                              </div>`
                });

                // Open the info window for the first park immediately
                if (index === 0) {
                    infoWindow.open(map, parkMarker);
                }

                // Open the info window on marker click
                naver.maps.Event.addListener(parkMarker, 'click', function () {
                    infoWindow.open(map, parkMarker);
                });
            });
        } else {
            alert('ì£¼ë³€ ê³µì›ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error ë°œìƒ:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}



    const categoryIcons = {
    'ì–‘ì‹': 'ğŸ”',  // Western food
    'í•œì‹': 'ğŸš',  // Korean food
    'ì¼ì‹': 'ğŸ£',  // Japanese food
    'ì¤‘í™”ìš”ë¦¬': 'ğŸ¥Ÿ',  // Chinese food
    'ì¹´í˜': 'â˜•',  // Cafe
    'ë¶„ì‹': 'ğŸ™',  // Snacks
    'í•´ì‚°ë¬¼': 'ğŸ¦',  // Seafood
    'ë² íŠ¸ë‚¨': 'ğŸœ',  // Vietnamese food
    'íƒœêµ­': 'ğŸ›',  // Thai food
    'ë©•ì‹œì½”': 'ğŸŒ®'  // Mexican food
};

async function searchAddressToCoordinate(query, category = null) {
    const clientId = 'XHZ9ADZ2rrQWqLCtLrc6';
    const clientSecret = 'BEuGuzPjRB';
    const encodedQuery = encodeURIComponent(query);
    const apiUrl = `https://openapi.naver.com/v1/search/local?query=${encodedQuery}&display=100`;
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const requestUrl = proxyUrl + apiUrl;

    try {
        const response = await fetch(requestUrl, {
            method: 'GET',
            headers: {
                'X-Naver-Client-Id': clientId,
                'X-Naver-Client-Secret': clientSecret
            }
        });

        if (!response.ok) throw new Error('API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

        const data = await response.json();

        if (data.items.length > 0) {
            const firstResult = data.items[0];
            const mapx = parseFloat(firstResult.mapx.substring(0, 3) + '.' + firstResult.mapx.substring(3));
            const mapy = parseFloat(firstResult.mapy.substring(0, 2) + '.' + firstResult.mapy.substring(2));
            const newLocation = new naver.maps.LatLng(mapy, mapx);

            map.setCenter(newLocation);

            // Add category-based markers for each result
            data.items.forEach(item => {
                const itemMapx = parseFloat(item.mapx.substring(0, 3) + '.' + item.mapx.substring(3));
                const itemMapy = parseFloat(item.mapy.substring(0, 2) + '.' + item.mapy.substring(2));
                const itemLocation = new naver.maps.LatLng(itemMapy, itemMapx);

                // Use category-specific icon (emoji)
                const iconText = categoryIcons[category] || 'ğŸ´'; // Default icon

                const marker = new naver.maps.Marker({
                    position: itemLocation,
                    map: map,
                    title: item.title,
                    icon: {
                        content: `<div class="category-marker">${iconText}</div>`,
                        size: new naver.maps.Size(30, 30),
                        anchor: new naver.maps.Point(15, 30)
                    }
                });

                // Calculate average rating using the provided function
                const averageRating = calculateAverageRating(item.title);

                // Info window content with details and calculated rating
                const infoWindowContent = `
                    <div style="padding:10px;">
                        <strong>${item.title}</strong><br />
                        <span>${item.category}</span><br />
                        <span>${item.roadAddress || item.address}</span><br />
                        <span>${averageRating}</span><br />
                        <a href="${item.link}" target="_blank">ìƒì„¸ì •ë³´</a><br/>
                        <a href="review.html?place=${encodeURIComponent(item.title)}">ë¦¬ë·°</a>
                    </div>`;

                const infoWindow = new naver.maps.InfoWindow({
                    content: infoWindowContent
                });

                // Open info window for the first marker automatically
                if (item === data.items[0]) {
                    infoWindow.open(map, marker);
                }

                // Open info window on marker click
                naver.maps.Event.addListener(marker, 'click', function () {
                    infoWindow.open(map, marker);
                });
            });
        } else {
            alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error ë°œìƒ:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}




    // ì‚¬ìš©ìê°€ Enterë¥¼ ëˆŒë €ì„ ë•Œ ê²€ìƒ‰ ì‹¤í–‰
    $('#address').on('keydown', function (e) {
    if (e.which === 13) {
        const address = $('#address').val();
        const query = `${address} ì• ê²¬ë™ë°˜ì‹ë‹¹`;
        searchAddressToCoordinate(query);
    }
});


    $('#submit').on('click', function () {
    const address = $('#address').val();
    const query = `${address} ì• ê²¬ë™ë°˜ì‹ë‹¹`; // Add pet-friendly keyword
    searchAddressToCoordinate(query);
});

    // ìŒì‹ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('.submit-form').on('click', function () {
        const address = $('#address').val();
        const category = $(this).data('query'); // Get the category from data attribute
        const query = `${address} ì• ê²¬ë™ë°˜ ${category}`;
        searchAddressToCoordinate(query,category);
    });
    $('#park-submit').on('click', function () {
        searchParksNearby();
    });
</script>

</body>
</html>
